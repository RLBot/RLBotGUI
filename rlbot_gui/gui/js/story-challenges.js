
import StoryUpgrades from './story-upgrades.js' 

const CITIES = {
    'INTRO': 1,
}

const CITY_STATE = {
    'LOCKED': 0,
    'OPEN': 1,
    'DONE': 2
}

const CITY_ICON_MAP = [
    'imgs/story/lock-100px.png', // LOCKED
    '',
    'imgs/story/checkmark-100px.png' // DONE
]

const DISPLAY_CITY_NAMES = {
    'INTRO': "Beginner's Park",
    'URBAN': 'Urban Central',
    'WASTELAND': 'Demolishing Wastelands',
    'CAMPANDSNIPE': 'Commonwealth of Campandsnipe',
    'CHAMPIONSIAN': 'Championsian Federation'
}

const OPEN_PREREQS = {
    'INTRO': [],
    'URBAN': ['INTRO'],
    'WASTELAND': ['URBAN'],
    'CAMPANDSNIPE': ['URBAN'],
    'CHAMPIONSIAN': ['WASTELAND', 'CAMPANDSNIPE']
}

const DONE_REQS = {
    'INTRO': ['INTRO-1'],
    'URBAN': ['URBAN-1'],
    'WASTELAND': ['WASTELAND-1'],
    'CAMPANDSNIPE': ['CAMPANDSNIPE-1'],
    'CHAMPIONSIAN': ['CHAMPIONSIAN-1']
}

const OVERLAY_LOCATIONS = {
    'INTRO': [390, 630],
    'URBAN': [350, 700],
    'WASTELAND': [85, 155],
    'CAMPANDSNIPE': [300, 500],
    'CHAMPIONSIAN': [64, 540]
}

export default {
    name: 'story-challenges',
    props: { saveState: Object, game_in_progress: Object },
    components:  {
        "story-upgrades": StoryUpgrades
    },
    template: `
    <div class="pt-2">
        <b-overlay :show="game_in_progress.name" rounded="sm" variant="dark">
            <b-card v-if="showIntroPopup()" class="mx-auto story-card-text" 
                style="width: 600px;"
                title="Are you ready?">
                <b-card-text>
                So you've got some wheels. You think that gives you the right to compete with the
                best? <strong>Your car doesn't even have boost!</strong>
                </b-card-text>

                <b-card-text>
                You are going to have to earn some cred by beating some nobody's like you first.
                </b-card-text>

                <b-button block @click="$emit('launch_challenge', 'INTRO-1')" variant="primary">
                Let's do it!
                </b-button>
            </b-card>

            <b-container fluid v-if="!showIntroPopup()" >
                <b-row>
                <b-col cols="auto">
                    <!-- Image Map Generated by http://www.image-map.net/ -->
                    <img src="imgs/story/story-mode-map.png" usemap="#image-map">
                    <map name="image-map">
                        <area class="story-clicky" @click.prev="handleCityClick" id="intro-area" alt="Beginner's Park" title="Beginner's Park" coords="649,380,601,379,586,457,566,479,599,525,635,546,718,566,718,514" shape="poly">
                        <area class="story-clicky" @click.prev="handleCityClick" id="urban-area" alt="Urban Central" title="Urban Central" coords="650,3,671,141,585,221,643,354,724,509,801,437,829,221,779,9" shape="poly">
                        <area class="story-clicky" @click.prev="handleCityClick" id="wasteland-area" alt="Demolishing Wastelands" title="Demolishing Wastelands" coords="1,18,229,541" shape="rect">
                        <area class="story-clicky" @click.prev="handleCityClick" id="campandsnipe-area" alt="Campandsnipe" title="Campandsnipe" coords="295,158,254,198,232,302,255,366,270,502,351,525,446,508,562,473,595,384,641,331,578,229,404,294,332,226,323,187,348,149,326,143" shape="poly">
                        <area class="story-clicky" @click.prev="handleCityClick" id="championsian-area" alt="Championsian Federation" title="Championsian Federation" coords="401,92,334,176,405,285,579,217,668,125,637,4,469,21" shape="poly">
                    </map>

                    <b-tooltip v-for="(location, city) in overlay_locations"
                        v-bind:target="city.toLowerCase() + '-area'"
                        triggers="hover">
                        {{getCityStateTooltip(city)}}
                    </b-tooltip>
                    <img v-for="(location, city) in overlay_locations"
                        class="story-map-icon"
                        v-bind:src="getImageForCity(city)"
                        v-bind:style="{top: location[0] + 'px', left: location[1] + 'px'}" 
                        v-if="getCityState(city) !== ${CITY_STATE.OPEN}" />
                </b-col>
                <b-col cols-xl="auto" class="story-dark-bg" style="min-width:200px; max-width:800px;">
                    <b-row class="h-50">
                        <b-card header="City Info" bg-variant="dark" class="w-100">
                        <b-card-text>
                            Click on a City to get started.
                        </b-card-text>
                        </b-card>
                    </b-row>
                    <b-row class="h-50">
                    <b-card no-body bg-variant="dark w-100">
                        <b-tabs content-class="mt-3" fill>
                            <b-tab title="Upgrades" active class="story-card-text">
                                <story-upgrades v-bind:upgradeSaveState="saveState.upgrades">
                                </story-upgrades>
                            </b-tab>
                            <b-tab title="Teammates"><p>I'm the second tab</p></b-tab>
                        </b-tabs>
                    </b-card>
                    </b-row>
                </b-col>
                </b-row>
            </b-container>
        </b-overlay>
    </div>
    `,
    data() {
        return {
            saveState: { // python StoryState class is canonical defintion of this object
            },
            game_in_progress: {},
            gameCompleted: false,
            overlay_locations: OVERLAY_LOCATIONS,
        }
    },
    methods: {
        getCityStateTooltip: function (city) {
            let state = this.getCityState(city)
            let displayName = DISPLAY_CITY_NAMES[city]

            const suffix = [
                'is still locked.',
                'is open to challenge!',
                'has been completed!'
            ]
            return displayName + ' ' + suffix[state]
        },
        handleCityClick: function (event) {
            // strip -area from id
            let city = event.target.id.substring(0, event.target.id.length - 5).toUpperCase()
            console.log(DISPLAY_CITY_NAMES[city])
        },
        showIntroPopup: function () {
            return !this.saveState.challenges_completed["INTRO-1"]
        },
        getCityState: function (city) {
            let state = CITY_STATE.LOCKED

            let prereqs = OPEN_PREREQS[city]
            if (prereqs.every(c => (this.getCityState(c) === CITY_STATE.DONE))) {
                state = CITY_STATE.OPEN

                // only need to check completion of challenges if we are open
                let donereqs = DONE_REQS[city]
                if (donereqs.every(c => this.saveState.challenges_completed[c])) {
                    state = CITY_STATE.DONE
                }
            }
            console.log(city, state)
            return state;
        },
        getImageForCity: function (city) {
            return CITY_ICON_MAP[this.getCityState(city)]
        }
    },
}
